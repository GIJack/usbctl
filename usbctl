#!/bin/sh
set -e

usage() {
	echo "Usage: $(basename "$0") [COMMAND]"
	echo "Control to deny new usb devices."
	echo
	echo "Available commands:"
	echo "  protect       disable protection against new usb devices"
	echo "  unprotect     enable protection against new usb devices"
	echo "  temporary     temporarily disable protection (default 10 sec)"
	echo "  status        print current protection status"
}

deny_new_usb() {
	echo "$1" | sudo tee /proc/sys/kernel/deny_new_usb > /dev/null
	usb_status
}

usb_status() {
	if grep -q 1 /proc/sys/kernel/deny_new_usb; then
		printf '\e[32;1m'
	else
		printf '\e[31;1mUN'
	fi
	printf 'PROTECTED\e[0m\n'
}

case "$1" in
	enable|unprotect)
		deny_new_usb 0
		;;
	disable|protect)
		deny_new_usb 1
		;;
	temporary|tmp|temp)
		deny_new_usb 0
		sleep 10
		deny_new_usb 1
		;;
	status)
		usb_status
		;;
	*)
		usage
		;;
esac
